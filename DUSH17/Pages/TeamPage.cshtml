
@page
@model DUSH17.Pages.TeamPageModel
<script>

		function squad()
		{
			document.getElementById("stat").setAttribute("style", "display: block");
			document.getElementById("achievment").setAttribute("style", "display: none");
		document.getElementById("matches").setAttribute("style", "display: none");
		}
		function achievments()
		{
			document.getElementById("stat").setAttribute("style", "display: none");
			document.getElementById("achievment").setAttribute("style", "display: block");
			document.getElementById("matches").setAttribute("style", "display: none");
		}
		function games()
		{
			document.getElementById("stat").setAttribute("style", "display: none");
			document.getElementById("achievment").setAttribute("style", "display: none");
			document.getElementById("matches").setAttribute("style", "display: block");
		}

	document.addEventListener('DOMContentLoaded', () => {

		const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;

		const comparer = (idx, asc) => (a, b) => ((v1, v2) =>
			v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2)
		)(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

		document.querySelectorAll('th').forEach(th => th.addEventListener('click', (() => {
			const table = th.closest('table');
			var tb = table.tBodies[0];
			Array.from(tb.querySelectorAll('tr:nth-child(n)'))
				.sort(comparer(Array.from(th.parentNode.children).indexOf(th), this.asc = !this.asc))
				.forEach(tr => tb.appendChild(tr));
		})));

	});
</script>


@{

	foreach (var t in Model.Teams)
	{
		@if (t.Year > 1999)
		{
			ViewData["Title"] = "Команда " + @t.Year + " года рождения";
		}
		else
		{
			ViewData["Title"] = "Женская футбольная команда СШ-17";
		}
		

		
		<div class="team_page">
			<div class="mini_teampage_header">
				@if(t.Year > 1999)
				{
					<h1>СШ-17 @t.Year года рождения</h1>
				}
				else
				{
					<h1>ЖФК СШ-17</h1>
				}
				
			</div>
			<div class="team_photo">
				<img class="team_page_photo" alt="Team" src="~/images/TeamsPhoto/@t.Picture.Name" />
			</div>
			<div style="position:relative">
				<div >
				<div class="teampage_header">
						@if (t.Year > 1999)
						{
							<h1>СШ-17 @t.Year года рождения</h1>
						}
						else
						{
							<h1>ЖФК СШ-17</h1>
						}
						
						<hr style="width:90%; color:#c5002e; height:4px;margin:0" />
				</div>

				<div class="team_info">
						<h4 style="grid-column-end:3; grid-column-start:1;margin-left:2%" title="Тренер-преподаватель">@t.Coach.Surname @t.Coach.Name @t.Coach.Patronymic</h4>
						@{
							int maxGoals = 0;
							int maxAs = 0;
							var footb = Model.Footballers.Where(team => team.TeamId == t.Id);
							if (footb.Count() > 0)
							{
								int id = footb.First().Id;
								int idA = footb.First().Id;
								int minMinutes = 0;
								int minMinutesA = 0;
								foreach (var foot in Model.Footballers.Where(i => i.TeamId == t.Id))
								{
									int totalMin = 0;
									foreach (var match in Model.Matches.Where(f => f.TeamId == foot.TeamId))
									{

										@if (match.Protocols.Where(pr => pr.FootballerId == foot.Id).Count() > 0)
										{

											int inMin = 0;
											int outMin = match.Competition.Minutes;
											foreach (var rep in Model.Replaces.Where(fb => fb.MatchID == match.Id && (fb.FootballerInId == foot.Id || fb.FootballerOutId == foot.Id)))
											{
												if (rep.FootballerOutId == foot.Id)
												{
													outMin = rep.Time;
												}
												if (rep.FootballerInId == foot.Id)
												{
													if (rep.Time == match.Competition.Minutes)
													{
														inMin = rep.Time - 1;
													}
													else
													{
														inMin = rep.Time;
													}
												}
											}
											totalMin += outMin - inMin;
										}
									}

									if (Model.Actions.Where(x => x.FootballerId == foot.Id && x.ActionTypeId == 1).Count() > maxGoals)
									{
										id = foot.Id;
										maxGoals = Model.Actions.Where(x => x.FootballerId == foot.Id && x.ActionTypeId == 1).Count();
										minMinutes = totalMin;
									}
									else if (Model.Actions.Where(x => x.FootballerId == foot.Id && x.ActionTypeId == 1).Count() == maxGoals)
									{
										if (totalMin < minMinutes)
										{
											id = foot.Id;
											maxGoals = Model.Actions.Where(x => x.FootballerId == foot.Id && x.ActionTypeId == 1).Count();
											minMinutes = totalMin;
										}
									}
									if (Model.Actions.Where(x => x.FootballerId == foot.Id && x.ActionTypeId == 2).Count() > maxAs)
									{
										idA = foot.Id;
										maxAs = Model.Actions.Where(x => x.FootballerId == foot.Id && x.ActionTypeId == 2).Count();
										minMinutesA = totalMin;
									}
									else if (Model.Actions.Where(x => x.FootballerId == foot.Id && x.ActionTypeId == 2).Count() == maxAs)
									{
										if (totalMin < minMinutesA)
										{
											idA = foot.Id;
											maxAs = Model.Actions.Where(x => x.FootballerId == foot.Id && x.ActionTypeId == 2).Count();
											minMinutesA = totalMin;
										}
									}

								}
								@foreach (var ff in Model.Footballers.Where(i => i.Id == id))
								{
									<h3>Бомбардир</h3>
									<a asp-page="PlayerPage" asp-route-Id="@ff.Id" style="text-decoration: none;color: black;"><h4>@ff.Name @ff.Surname</h4></a>

								}
								@foreach (var ff in Model.Footballers.Where(i => i.Id == idA))
								{
									<h3>Ассистент</h3>
									<a asp-page="PlayerPage" asp-route-Id="@ff.Id" style="text-decoration: none;color: black;"><h4>@ff.Name @ff.Surname</h4></a>

								}


							}
							<h3 style="">Результаты</h3><h3></h3>
							<div style="margin-left:8%;margin-bottom:5%" class="lastgames">
								@foreach (var m in Model.Matches.Where(i => i.TeamId == t.Id).OrderByDescending(d => d.Date).ThenByDescending(i=>i.Id).Take(10))
								{

									@if (m.Goals > m.OpponentGoals)
									{
										<p title="СШ-17 @m.Goals:@m.OpponentGoals @m.Opponent.Name" style="text-align: center;margin-top:2px"><ps style="background-color:lawngreen;border:solid 1px black;color:black;font-weight: bold;padding-left:5px;padding-right:5px">В</ps></p>
									}
									else if (m.Goals < m.OpponentGoals)
									{
										<p title="СШ-17 @m.Goals:@m.OpponentGoals @m.Opponent.Name" style="text-align: center;margin-top:2px"><ps style="background-color:red;border:solid 1px black;color:black;font-weight: bold;padding-left:5px;padding-right:5px">П</ps></p>
									}
									else
									{
										<p title="СШ-17 @m.Goals:@m.OpponentGoals @m.Opponent.Name" style="text-align: center;margin-top:2px"><ps style="background-color:yellow;border:solid 1px black;color:black;font-weight: bold;padding-left:5px;padding-right:5px">Н</ps></p>
									}

								}
							</div>

						}

				</div>



				</div>

				<div class="teamstat_div">
					<table class="teamstat" >
						<thead class="fullth">
							<tr>
								<th style ="border-left:none">Матчи</th>
								<th>Победы</th>
								<th>Ничьи</th>
								<th>Поражения</th>
								<th>Забито</th>
								<th style="border-right:none">Пропущено</th>
							</tr>
						</thead>
						<thead class="minith">
							<tr>
								<th style="border-left:none">М</th>
								<th>Поб</th>
								<th>Нич</th>
								<th>Пор</th>
								<th>МЗ</th>
								<th style="border-right:none">МП</th>
							</tr>
						</thead>
						<tbody>
							@{
								int wins = 0;
								int loses = 0;
								int draws = 0;
								int scored = 0;
								int missed = 0;
								foreach (var m in Model.Matches.Where(i => i.TeamId == t.Id))
								{
									scored += m.Goals;
									missed += m.OpponentGoals;
									if (m.Goals > m.OpponentGoals)
									{
										wins++;
									}
									else if (m.Goals < m.OpponentGoals)
									{
										loses++;
									}
									else
									{
										draws++;
									}
								}
							}
							<tr>
								<td style="border-left:none; font-weight:bold">@Model.Matches.Where(i => i.TeamId == t.Id).Count()</td>
								<td style="font-weight:bold">@wins</td>
								<td style="font-weight:bold">@draws</td>
								<td style="font-weight:bold">@loses</td>
								<td style="font-weight:bold">@scored</td>
								<td style="border-right:none; font-weight:bold">@missed</td>
							</tr>
						</tbody>
					</table>
				</div>

			</div>
			<div class="team_menu" id="TeamMenu" style="">
				<button class="button-80" id="squad" runat="server" onclick="squad()" style=" text-align:center;width:26%">Состав</button>
				<button class="button-80" id="achievments" runat="server" onclick="achievments()" style=" text-align:center;width:26%">  Достижения</button>
				<button class="button-80" id="matches1" runat="server" onclick="games()" style=" text-align:center;width:26%">  Результаты</button>

			</div>
			<nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white box-shadow mb-3 teampagenav" style="margin-bottom:0 !important;padding:0 !important;border-radius:0px 0px 8px 8px">
				<div class="container">
					<button style="border:none;height:10%;margin-top:1%; margin-bottom:1%" class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#xxx" aria-controls="navbarSupportedContent"
						aria-expanded="false" aria-label="Toggle navigation">
						<span class="navbar-toggler-icon"></span>
					</button>
					<div id="xxx" class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
						<ul class="navbar-nav flex-grow-1">
							<li class="nav-item teampage">
								<a onclick="squad()" style="text-decoration:none; color:black;cursor:pointer">Состав</a>
							</li>
							<li class="nav-item teampage">
								<a onclick="achievments()" style="text-decoration:none; color:black;cursor:pointer">Достижения</a>
							</li>
							<li class="nav-item teampage">
								<a onclick="games()" style="text-decoration:none; color:black;cursor:pointer">Результаты</a>
							</li>
						</ul>
					</div>

				</div>
			</nav>
		</div>


		<div class="team_stat" id="stat">



			<div class="head_TeamList" style="">
				Список игроков команды
				<div class="add" style="position:absolute;right:17%">
					
					@if (User.Identity.Name != null)
					{
						<form asp-page="./Create" method="get">
							<a style="color:white" href="/Create/?tId=@t.Id">Добавить спортсмена</a>
						</form>
					}
				</div>

			</div>
			<table>
				<thead>
					@if (User.Identity.Name != null)
					{
						<tr><th style="text-align:center;padding-left:1%">ФИО</th><th style="">Позиция</th><th style="padding-left: 0">Дата Рождения</th><th style="text-align: center;">Игры</th><th style="text-align: center;">Минуты</th><th style="text-align: center;">Г</th><th style="text-align: center;">Г/90</th><th style="text-align: center;">П</th><th style="text-align: center;">П/90</th><th style="text-align: center;">Г+П</th><th style="text-align: center;">ЖК</th><th style="text-align: center;">КК</th><th class="add" style="border:none" width="5%"></th></tr>
					}
					else
					{
						<tr><th style="text-align:center;padding-left:1%">ФИО</th><th style="">Позиция</th><th style="padding-left: 0">Дата Рождения</th><th style="text-align: center;">Игры</th><th style="text-align: center;">Минуты</th><th style="text-align: center;">Г</th><th style="text-align: center;">Г/90</th><th style="text-align: center;">П</th><th style="text-align: center;">П/90</th><th style="text-align: center;">Г+П</th><th style="text-align: center;">ЖК</th><th style="text-align: center;">КК</th></tr>
					}
					
				</thead>
				<tbody>
					@foreach (var person in Model.Footballers.OrderBy(pos => pos.PositionId).ThenBy(i=>i.Surname + i.Name + i.Patronymic))
					{
						<tr>
							<td style="padding-left: 1%;"><a asp-page="PlayerPage" asp-route-Id="@person.Id" style="text-decoration: none;color:black">@person.Surname @person.Name @person.Patronymic</a></td>
							<td style ="text-align:center">@person.Position.ShortName.ToUpper()</td>
							<td style="padding-left: 0; text-align: center">@person.DateOfBirthday</td>
							<td style="text-align: center;">@Model.Protocols.Where(i => i.FootballerId  == person.Id).Count()</td>
							@{
								double totalMin = 0;
								foreach (var match in Model.Matches.Where(f => f.TeamId == person.TeamId))
								{
									
									@if (match.Protocols.Where(pr => pr.FootballerId == person.Id).Count() > 0)
									{
										@if (Model.Actions.Where(i=>i.FootballerId == person.Id && i.MatchId == match.Id && i.ActionTypeId == 6).Count() > 0)
										{
											int inMin = 0;
											int outMin = match.Competition.Minutes;
											foreach (var rep in Model.Replaces.Where(fb => fb.MatchID == match.Id && (fb.FootballerInId == person.Id || fb.FootballerOutId == person.Id)))
											{
												if (rep.FootballerOutId == person.Id)
												{
													outMin = rep.Time;
												}
												if (rep.FootballerInId == person.Id)
												{
													if (rep.Time == match.Competition.Minutes)
													{
														inMin = rep.Time - 1;
													}
													else
													{
														inMin = rep.Time;
													}
												}
											}
											totalMin += outMin - inMin;
										}

									}

								}

							}
							<td style="text-align: center;">@totalMin</td>
							<td style="text-align: center;">@Model.Actions.Where(g=>g.FootballerId == person.Id && g.ActionTypeId == 1).Count()</td>
							@{
								double g90 = 0;
								if (@Model.Actions.Where(g => g.FootballerId == person.Id && g.ActionTypeId == 6).Count() != 0)
								{
									g90 = Math.Round((Convert.ToDouble(@Model.Actions.Where(g => g.FootballerId == person.Id && g.ActionTypeId == 1).Count()) / (totalMin / 90)), 2);

								}
							}
							<td style="text-align: center;">@g90</td>
							<td style="text-align: center;">@Model.Actions.Where(g=>g.FootballerId == person.Id && g.ActionTypeId == 2).Count()</td>
							@{
								double gp90 = 0;
								if (@Model.Actions.Where(g => g.FootballerId == person.Id && g.ActionTypeId == 6).Count() != 0)
								{
									gp90 = Math.Round((Convert.ToDouble(@Model.Actions.Where(g => g.FootballerId == person.Id && g.ActionTypeId == 2).Count()) / (totalMin / 90)), 2);

								}
							}
							<td style="text-align: center;">@gp90</td>
							@{
								int gp = (@Model.Actions.Where(g => g.FootballerId == person.Id && g.ActionTypeId == 1).Count() + @Model.Actions.Where(g => g.FootballerId == person.Id && g.ActionTypeId == 2).Count());
							}
							<td style="text-align: center;">@gp</td>
							<td style="text-align: center;">@Model.Actions.Where(g=>g.FootballerId == person.Id && g.ActionTypeId == 3).Count()</td>
							<td style="text-align: center;">@Model.Actions.Where(g=>g.FootballerId == person.Id && g.ActionTypeId == 4).Count()</td>
							@if (User.Identity.Name != null)
							{
								<td class="add" style="text-align: right">
									<form method="post">
										<a asp-page="Edit" asp-route-id="@person.Id" style="" title="Редактировать"><img src="~/images/Icons/edit.png" style="width:25%" /></a>
										<button type="submit" asp-page-handler="delete" asp-route-id="@person.Id " style="background:none; border:none; padding-bottom:0" title="Удалить">
											<img src="~/images/Icons/delete.png"  style="width:100%"/>
										</button>
									</form>
								</td>
							}

						</tr>
					}
				</tbody>
			</table>

		</div>
		<div class="team_stat" id="achievment" style="display:none">

			<div class="head_TeamList">
				Список достижений
				<div style="position:absolute;right:17%">

					@if (User.Identity.Name != null)
					{
						<form asp-page="./Create" method="get">
							<a class="add" style="color:white" href="/CreateAchievement/?tId=@t.Id&year=@t.Year">Добавить результат соревнования</a>
						</form>
					}
				</div>
			</div>
			<table class="">
				<thead>
				@if (User.Identity.Name != null)
				{
						<tr><th style="border-left:none">Год</th><th>Соревнование</th><th>Уровень соревнования</th><th>Команд</th><th style="text-align:center">Место</th> <th class="add" width="5%"></th></tr>
				}
				else
				{
						<tr><th style="border-left:none">Год</th><th>Соревнование</th><th>Уровень соревнования</th><th>Команд</th><th style="text-align:center">Место</th></tr>
				}

				</thead>
				<tbody >
					@foreach (var a in Model.Achievments.OrderByDescending(y=>y.Competition.EndDate))
					{
						<tr>
							<td style="text-align:center;border-left:none;border-bottom:1px solid lightgray;">@a.Competition.StartDate.Year</td>
							<td style="padding-left:1%;border-bottom:1px solid lightgray;">@a.Competition.NameOfCompetition</td>
							<td style="padding-left:1%;border-bottom:1px solid lightgray;">@a.Competition.CompetitionLevel.Level</td>
							<td style="padding-left:1%;border-bottom:1px solid lightgray;text-align:center">@a.Competition.CountOfTeams</td>
							<td style="text-align:center;border-bottom:1px solid lightgray;border-right:1px solid lightgray">@a.Place</td>
							@if (User.Identity.Name != null)
							{
								<td class="add" style="text-align:center; border:none">
									<form method="post">
										<a asp-page="Edit" asp-route-id="@t.Id" style="" title="Редактировать"><img src="~/images/Icons/edit.png" style="width:25%" /></a>
										<button type="submit" asp-page-handler="delete" asp-route-id="@t.Id " style="background:none; border:none; padding-bottom:0" title="Удалить">
											<img src="~/images/Icons/delete.png" style="width:100%" />
										</button>
									</form>
									</td>
							}

						</tr>
					}

				</tbody>
			</table>

		</div>
		<div class="team_stat" id="matches" style="display:none">

			<div class="head_TeamList">Список матчей
				<div class="add" style="position:absolute;right:17%">
					
					@if (User.Identity.Name != null)
					{
							<a style="color:white;font-size:14px" href="/CreateCompetition">Добавить соревнование</a>
							<a style="color:white;font-size:14px" asp-page="SelectCompetition" asp-route-id="@t.Id" style="">Добавить результат матча</a>

					}
				</div>
			</div>
			<table class="" id="table1">

				<thead>
					@if (User.Identity.Name != null)
					{
						<tr> <th style="text-align: center;border-left:none;padding-right:0">Дата</th><th style="text-align: center;">Соревнование(уровень)</th><th style="text-align: center;">Соперник</th><th style="text-align: center;">Результат</th><th style="text-align: center;">Счет</th><th class="add" width="5%"></th></tr>
					}
					else
					{
						<tr> <th style="text-align: center;border-left:none;padding-right:0;width:10%">Дата</th><th style="text-align: center;width:50%">Соревнование(уровень)</th><th style="text-align: center;width:25%">Соперник</th><th style="text-align: center;">Результат</th><th style="text-align: center;">Счет</th></tr>
					}
					
				</thead>
				<tbody>
					@foreach (var m in Model.Matches.Where(i => i.TeamId == t.Id).OrderByDescending(y=>y.Date).ThenByDescending(y=>y.Id))
					{
						
						<tr>


							<td style="text-align: center;"><a asp-page="Match" asp-route-id="@m.Id" style="text-decoration:none;color:black">@m.Date</a></td>
							<td style="text-align: center;"><a asp-page="Match" asp-route-id="@m.Id" style="text-decoration:none;color:black">@m.Competition.NameOfCompetition (@m.Competition.CompetitionLevel.Level)</a></td>
							<td class="big_td" style="text-align: left; white-space:nowrap;padding-left:2%"><a asp-page="Match" asp-route-id="@m.Id" style="text-decoration:none;color:black"><img src="~/images/Opponents/@m.Opponent.Picture.Name" style="" /> @m.Opponent.Name @m.Opponent.Year</a></td>
							<td class="mini_td" style="text-align: center;"><a asp-page="Match" asp-route-id="@m.Id" style="text-decoration:none;color:black"><img src="~/images/Opponents/@m.Opponent.Picture.Name" style="" /></a></td>
							@if (m.Goals > m.OpponentGoals)
							{
								<td style="text-align: center;"><a asp-page="Match" asp-route-id="@m.Id" style="text-decoration:none;color:black"><ps style="background-color:lawngreen;border:solid 1px black;color:black;font-weight: bold;padding-left:5px;padding-right:5px">В</ps></a></td>
							}
							else if (m.Goals < m.OpponentGoals)
							{
								<td style="text-align: center;"><a asp-page="Match" asp-route-id="@m.Id" style="text-decoration:none;color:black"><ps style="background-color:red;border:solid 1px black;color:black;font-weight: bold;padding-left:5px;padding-right:5px">П</ps></a></td>
							}
							else
							{
								<td style="text-align: center;"><a asp-page="Match" asp-route-id="@m.Id" style="text-decoration:none;color:black"><ps style="background-color:yellow;border:solid 1px black;color:black;font-weight: bold;padding-left:5px;padding-right:5px">Н</ps></a></td>
							}
							<td style="text-align: center;"><a asp-page="Match" asp-route-id="@m.Id" style="text-decoration:none;color:black">@m.Goals : @m.OpponentGoals</a></td>
							@if (User.Identity.Name != null)
							{
								<td class="add" style="text-align: right">
									<form method="post">
										<a asp-page="Edit" asp-route-id="@t.Id" style="" title="Редактировать"><img src="~/images/Icons/edit.png" style="width:25%" /></a>
										<button type="submit" asp-page-handler="delete" asp-route-id="@t.Id " style="background:none; border:none; padding-bottom:0" title="Удалить">
											<img src="~/images/Icons/delete.png"  style="width:100%"/>
										</button>
									</form>
								</td>
							}
							
						</tr>
						
					}
				</tbody>
			</table>
		</div>
	}
	}